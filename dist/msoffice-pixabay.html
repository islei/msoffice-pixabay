<!DOCTYPE html>
<html>

<head>
    <base href="/">
    <title>Run: Pixabay</title>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="" />

    <!-- For purposes of experimentation, disable caching, so that can make changes and see results immediately on reload: -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <!-- Office.js Reference -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/office-ui-fabric-js@1.4.0/dist/css/fabric.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/office-ui-fabric-js@1.4.0/dist/css/fabric.components.min.css" />

    <!-- Style -->
    <style type="text/css">
        body {
            margin: 0;
            padding: 10px;
        }
        .ms-Grid-col {
            padding: 0;
        }
        /* Search Box */
        .ms-SearchBox, .ms-SearchBox-field {
           width: 100%;
        }
        /* Spinner */
        #pxb-spinner-container {
            display: none; 
        }
        #pxb-spinner-container .ms-Spinner{
            position: absolute;
            margin: auto;
            left: 0;
            right: 0;
            width: 20px;
            height: 20px;
        }
        /* Result Container */
        #pxb-result-container {
            margin-top: 10px;
        }
        #pxb-result-container > div:first-child {
            padding-right: 5px;
        }
        #pxb-result-container > div > img {
            width: 100%;
        }
        /* Pagination */
        #pxb-pagination {
            text-align: center;
            width: 100%;
            margin-top: 20px;
        }
        #pxb-pagination a { 
            color: #333;
            padding: 5px 10px;
            text-align: center;
            cursor: pointer;
        }
        #pxb-pagination a.active { 
            font-weight: 700;
            text-decoration: underline;
        }
        /* Footer */
        #pxb-footer-container {
            border-top: 1px solid #ccc;
            margin-top: 20px;
        }
        #pxb-footer-container span {
            margin: 10px 0;
            font-size: 12px;
            line-height: 1.7;
            color: #555;
            display: block;
            float: left;
            padding :9px 12px 6px;
            border: 1px solid #ccc;
        }
        #pxb-footer-container i {
            display: block;
            width: 68px;
            height: 18px;
            overflow: hidden;
        }
        #pxb-footer-container img {
            width: 94px
        }
    </style>
</head>

<body>
    <!-- HTML -->
    <div class="ms-Grid">
    	<!-- Search Box -->
    	<div class="ms-Grid-row">
    		<div class="ms-Grid-col ms-u-sm12">
    			<div class="ms-SearchBox">
    				<input id="pxb-searchBox-field" class="ms-SearchBox-field" value="">
    				<label class="ms-SearchBox-label">
    					<i class="ms-SearchBox-icon ms-Icon ms-Icon--Search"></i>
    					<span class="ms-SearchBox-text">Search</span>
    				</label>
    				<div class="ms-CommandButton ms-SearchBox-clear ms-CommandButton--noLabel">
    					<button class="ms-CommandButton-button">
                			<span class="ms-CommandButton-icon ">
    							<i class="ms-Icon ms-Icon--Clear"></i>
    						</span>
    						<span class="ms-CommandButton-label"></span>
            			</button>
    				</div>
    			</div>
    		</div>
    	</div>
    	<!-- Spinner -->
    	<div id="pxb-spinner-container" class="ms-Grid-row">
    		<span class="ms-Spinner"></span>
    	</div>
    	<!-- Search Results -->
    	<div id="pxb-result-container" class="ms-Grid-row">
    		<div class="ms-Grid-col ms-u-sm6"></div>
    		<div class="ms-Grid-col ms-u-sm6"></div>
    	</div>
    	<!-- Pagination -->
    	<div id="pxb-pagination"></div>
    	<!-- Footer -->
    	<div id="pxb-footer-container" class="ms-Grid-row">
    		<a href="https://pixabay.com/">
    			<i><img src="/office/pixabay.svg"></i>	Free Images
    		</a>
    	</div>
    </div>
    
    

    <!-- ScriptLab-Specific Runtime Helpers -->
    <script src="https://script-lab.azureedge.net/runtime-helpers.js?hash=aa0d3ff3e68d9a8b0d5d"></script>
    <script>
        ScriptLab._strings = {"unexpectedError":"An unexpected error occurred","authenticationWasCancelledByTheUser":"Authentication was cancelled by the user","officeVersionDoesNotSupportAuthentication":"Your current version of Office does not support displaying an authentication dialog. Please update to a newer version, or try Office Online, if you would like to run this snippet."};
    </script>
    
    <!-- JS Libraries -->
    <script crossorigin="anonymous" src="https://unpkg.com/core-js@2.4.1/client/core.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@microsoft/office-js-helpers@.5.0/dist/office.helpers.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/jquery@3.1.1"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/office-ui-fabric-js@1.4.0/dist/js/fabric.min.js"></script>
    <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Paging/1.2.0/jquery.paging.min.js"></script>

    <!-- Script -->
    <script type="text/javascript">
        Office.initialize = function() {
            "use strict";
            var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
                return new (P || (P = Promise))(function (resolve, reject) {
                    function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
                    function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
                    function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
                    step((generator = generator.apply(thisArg, _arguments || [])).next());
                });
            };
            var __generator = (this && this.__generator) || function (thisArg, body) {
                var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t;
                return { next: verb(0), "throw": verb(1), "return": verb(2) };
                function verb(n) { return function (v) { return step([n, v]); }; }
                function step(op) {
                    if (f) throw new TypeError("Generator is already executing.");
                    while (_) try {
                        if (f = 1, y && (t = y[op[0] & 2 ? "return" : op[0] ? "throw" : "next"]) && !(t = t.call(y, op[1])).done) return t;
                        if (y = 0, t) op = [0, t.value];
                        switch (op[0]) {
                            case 0: case 1: t = op; break;
                            case 4: _.label++; return { value: op[1], done: false };
                            case 5: _.label++; y = op[1]; op = [0]; continue;
                            case 7: op = _.ops.pop(); _.trys.pop(); continue;
                            default:
                                if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                                if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                                if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                                if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                                if (t[2]) _.ops.pop();
                                _.trys.pop(); continue;
                        }
                        op = body.call(thisArg, _);
                    } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
                    if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
                }
            };
            
            var CONFIG = {
                API_KEY: "YOUR_API_KEY",
                PIXABAY_URL: "https://pixabay.com/api/",
                RESULTS_PER_PAGE: 20,
            };
            // init search box
            var SearchBoxElement = document.querySelector(".ms-SearchBox");
            var searchBox = new fabric['SearchBox'](SearchBoxElement);
            // init spinner
            var SpinnerElement = document.querySelector('.ms-Spinner');
            var spinner = new fabric['Spinner'](SpinnerElement);
            // on search
            $('#pxb-searchBox-field').keypress(function (event) {
                if (event.keyCode == 13) {
                    var searchVal = $(this).val();
                    if (!searchVal)
                        return;
                    search(searchVal);
                }
            });
            /**
             * Search for images on pixabay using the keyword(s)
             */
            function search(searchVal, options) {
                // get options
                var page = options && options.page ? options.page : 1;
                // send
                $.ajax({
                    url: CONFIG.PIXABAY_URL,
                    data: {
                        key: CONFIG.API_KEY,
                        per_page: CONFIG.RESULTS_PER_PAGE,
                        page: page,
                        q: searchVal,
                    },
                    beforeSend: function () {
                        $("#pxb-result-container > div").empty();
                        $("#pxb-spinner-container").css("display", "block");
                    },
                    success: function (response) {
                        var hits = response.hits;
                        var totalHits = response.totalHits;
                        // populate result container with preview images
                        $.each(hits, function (i, hit) {
                            var previewImg = $('<img src="' + hit.previewURL + '" />');
                            // on preview image click
                            previewImg.click(function () {
                                insertImage(hit.webformatURL);
                            });
                            var selector = (i & 1) ? "first" : "last";
                            selector = "#pxb-result-container > div:" + selector + "-child";
                            $(selector).append(previewImg);
                        });
                        // set pagination
                        if (page != 1)
                            return;
                        $("#pxb-pagination").paging(totalHits, {
                            format: '< ncnnn >',
                            perpage: CONFIG.RESULTS_PER_PAGE,
                            onSelect: function (page) {
                                if (page == 1)
                                    return;
                                search(searchVal, { page: page });
                            },
                            onFormat: formatPaging,
                        });
                    },
                    complete: function () {
                        // hide spinner
                        $("#pxb-spinner-container").css("display", "none");
                    }
                });
            }
            /**
             * Paging button formatter
             */
            function formatPaging(type) {
                switch (type) {
                    case 'block':
                        if (this.value != this.page)
                            return '<a>' + this.value + '</a>';
                        return '<a class="active">' + this.value + '</a>';
                    case 'next':
                        return '<a>&gt;</a>';
                    case 'prev':
                        return '<a>&lt;</a>';
                }
            }
            /**
             * Inserts an image at the cursor position
             */
            function insertImage(imageUrl) {
                return __awaiter(this, void 0, void 0, function () {
                    var exception_1;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                _a.trys.push([0, 2, , 3]);
                                return [4 /*yield*/, toDataURL(imageUrl, function (dataUrl) {
                                        var base64result = dataUrl.split(',')[1];
                                        Office.context.document.setSelectedDataAsync(base64result, {
                                            coercionType: Office.CoercionType.Image,
                                            imageLeft: 50,
                                            imageTop: 50,
                                            imageWidth: 400
                                        });
                                    })];
                            case 1:
                                _a.sent();
                                return [3 /*break*/, 3];
                            case 2:
                                exception_1 = _a.sent();
                                OfficeHelpers.Utilities.log(exception_1);
                                return [3 /*break*/, 3];
                            case 3: return [2 /*return*/];
                        }
                    });
                });
            }
            /**
             * convert image to base64 data uri
             */
            function toDataURL(url, callback) {
                return __awaiter(this, void 0, void 0, function () {
                    var xhr;
                    return __generator(this, function (_a) {
                        xhr = new XMLHttpRequest();
                        xhr.onload = function () {
                            var reader = new FileReader();
                            reader.onloadend = function () {
                                callback(reader.result);
                            };
                            reader.readAsDataURL(xhr.response);
                        };
                        xhr.open('GET', url);
                        xhr.responseType = 'blob';
                        xhr.send();
                        return [2 /*return*/];
                    });
                });
            }
            
        };

    </script>
</body>

</html>
